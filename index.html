<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Tag-Selector</title>
  <meta name="description" content="Tag-Selector">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
</head>

<body>
  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        </div>
        <div class="modal-body" id="modalBody">
      </div>
  </div>
</div>
</div>
  <div class ="container">
    <div class ="row">
      <div class = "col-md-3">
        <div class='panel panel-default'>
          <div class="panel-body" id='tags'></div>
        </div>
        <button class="btn btn-primary" onclick="getImages()">Get Images</button>
      </div>
      <div class="col-md-9" id= "images">

      </div>
    </div>
  </div>
  <script>
      var getImages = function(){
        var qury = "";
        var checked = []
        var cbs = document.getElementById("tags").childNodes
        for(var i = 0; i < cbs.length; i++){
          console.log(cbs[i].childNodes[0].childNodes[0])
          if(cbs[i].childNodes[0].childNodes[0].nodeName == 'INPUT'){
            if(cbs[i].childNodes[0].childNodes[0].checked == true){
              checked.push(cbs[i].childNodes[0].childNodes[0].id)
            }
          }
        }
        for(var i =0; i < checked.length; i++){
          if(i == 0){
            qury = '/?tag'+i+"="+checked[i]
          }else {
            qury = qury+'&tag'+i+"="+checked[i]
          }
        }
        TINY.ajax.call('/getImages'+qury, 'content', 'handleImages');
      }

    TINY={};

    function T$(id){return document.getElementById(id)}

    TINY.ajax=function(){
      return{
        call:function(u,d,f,p){
            var x=window.XMLHttpRequest?new XMLHttpRequest():new ActiveXObject('Microsoft.XMLHTTP');
            x.onreadystatechange=function(){
                if(x.readyState==4&&x.status==200){
                  ACTIONS[f](x.responseText)
                }
            };
            if(p){
                x.open('POST',u,true);
                x.setRequestHeader('Content-type','application/x-www-form-urlencoded');
                x.send(p)
            }else{
                x.open('GET',u,true);
                x.send(null)
            }
          }
      };
    }();

    var setImage = function(im){
      var m = document.getElementById("modalBody")
      m.innerHTML = "";
      var img = document.createElement("img");
      img.src = "/"+im
      img.setAttribute("style", "max-width:100%");
      m.appendChild(img)

    }

    TINY.ajax.call('/getTags', 'content', 'handleTags');
    TINY.ajax.call('/getImages', 'content', 'handleImages');
    ACTIONS = {

        handleImages: function(data){
          var imageElem = document.getElementById("images")
          imageElem.innerHTML = ''
          var images = JSON.parse(data)
          for(var i = 0; i < images.length; i++){
            var d = document.createElement("div");
            d.id = images[i].id+'_'+images[i].name;
            d.className = 'col-xs-6 col-md-3';
            var a = document.createElement("a");
            a.type="button"
            a.setAttribute("data-toggle","modal")
            a.setAttribute("data-target","#myModal")
            a.setAttribute("data-value", images[i].name);
            //a.href = "/"+images[i].name;
            a.href = '#';
            a.id = images[i].name;
            a.className = 'thumbnail'
            var im = document.createElement("img");
            im.src = "/icon.png";
            a.appendChild(im);
            var name = images[i].name
            name = name.replace(".png","")
            name = name.replace(".jpg","")

            a.appendChild(document.createTextNode(name));
            d.appendChild(a);
            imageElem.appendChild(d);
            a.onclick = function(event) {
              setImage(event.srcElement.getAttribute("data-value"))
            };
          }
        },

        handleTags: function(data){
          var tagElem = document.getElementById("tags")
          var tags = JSON.parse(data)
            for(var i = 0;i < tags.length; i++){
              if(tags[i].name != '_Digikam_Internal_Tags_'){
                var t = document.createElement("input")
                t.type = "checkbox";
                t.id = tags[i].name
                var l = document.createElement('label')
                l.appendChild(t)
                l.appendChild(document.createTextNode(tags[i].name))
                var d = document.createElement("div")
                d.className = "checkbox"
                d.appendChild(l)
                tagElem.appendChild(d)
              }
            }
        }
    };

  </script>
</body>
</html>
